@{
    ViewData["Title"] = "Chat with User";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid h-100 py-3">
    <div class="row h-100">
        <div class="col-12 col-md-8 mx-auto">
            <!-- Chat Header -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center me-3" 
                             style="width: 40px; height: 40px">
                            <img id="receiverImage" src="" alt="receiver profile" class="rounded-circle"
                            onerror="this.src='/profile_images/placeholder.jpg'"
                            style="width:40px; height:40px;" />
                        </div>
                        <div>
                            <h5 class="mb-0" id="receiverName"></h5>
                            <small id="onlineStatus" class="text-white-50"></small>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-box" class="card-body bg-light" 
                     style="height: 65vh; overflow-y: auto; scrollbar-width: thin;">
                </div>

                <!-- Message Input -->
                <div class="card-footer bg-white">
                    <form id="chatForm" class="mb-0">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-0" id="emojiButton">
                                <i class="fa-solid fa-face-smile"></i>
                            </span>
                            <input type="text" id="message" class="form-control border-0" 
                                   placeholder="Type a message..." autocomplete="off">
                            <span class="input-group-text bg-white border-0">
                                <i class="fa-solid fa-paperclip"></i>
                            </span>
                            <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                        <!-- Emoji Picker Container -->
                        <div id="emoji-container" class="position-absolute bottom-100 start-0 mb-2 d-none" 
                             style="z-index: 1050; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 10px; width: 300px; max-height: 200px; overflow-y: auto;">
                            <div class="d-flex flex-wrap">
                                <!-- Emojis will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
<script>
    const receiverId = window.location.href.split("/").pop();
    console.log("receiverId in url:", receiverId);
    let receiver = null;
    let connection;
    const user = JSON.parse(sessionStorage.getItem("user"));
    const baseUrl = "http://localhost:5267/api";
    //
    //
    function getFormData() {
        const formData = new FormData();
        formData.append("Message", $("#message").val());
        formData.append("SenderId", user.userId);
        formData.append("ReceiverId", receiverId);

        return formData;
    }
    //
    function loadReceiverData() {
        return new Promise(function(resolve, reject) {
            $.ajax({
                url: `${baseUrl}/user/${receiverId}`,
                method: "GET",
                success: function (response, status, xhr) {
                    receiver = response.data;
                    $('#receiverName').text(receiver.firstName + " " + receiver.lastName);
                    $('#receiverImage').attr('src', `/profile_images/${receiver.image}`);
                    $('#onlineStatus').html(receiver?.isOnline == true ? `<i class="fa-solid fa-circle-check me-1"></i>Online` : `<i class="fa-solid fa-circle-xmark me-1"></i>Offline`);
                    //
                    resolve();
                },
                error: function (xhr, status, error) {
                    console.error("loadReceiverData():\n", xhr.responseJSON);
                    reject();
                }
            });
        });
    }
    //
    // Update the message append template in loadChatHistory and ReceiveMessage functions
    function appendMessage(chat, senderName) {
        let alignClass = (chat.senderId == user.userId) ? "justify-content-end" : "justify-content-start";
        let bubbleClass = (chat.senderId == user.userId) ? "bg-primary text-white" : "bg-white";
        let timestamp = new Date(chat.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let messageStatus = chat.status || 'sent';
        let statusIcon = getStatusIcon(messageStatus);

        $("#chat-box").append(`
            <div class="d-flex ${alignClass} mb-3" data-message-id="${chat.chatId}">
                <div class="d-flex flex-column ${bubbleClass} shadow-sm rounded-3 p-3" style="max-width: 75%;">
                    <div class="message-text">${chat.message}</div>
                    <small class="text-${chat.senderId == user.userId ? 'white-50' : 'muted'} align-self-end mt-1">
                        ${timestamp}
                        ${statusIcon}
                    </small>
                </div>
            </div>
        `);
    }

    function getStatusIcon(status) {
        switch(status) {
            case 'sent':
                return '<i class="fa-solid fa-check"></i>';
            case 'delivered':
                return '<i class="fa-solid fa-check-double"></i>';
            case 'read':
                return '<i class="fa-solid fa-check-double text-primary"></i>';
            default:
                return '<i class="fa-solid fa-clock"></i>';
        }
    }
    //
    // Update loadChatHistory function to use the new appendMessage
    function loadChatHistory() {
        $.ajax({
            url: `${baseUrl}/chat/history/${user.userId}/${receiver.userId}`,
            method: "GET",
            success: function (response) {
                $("#message").val("");
                console.log("Chat History Loaded:", response);
                const chatArray = response.data;
                $("#chat-box").html("");

                chatArray.forEach(chat => {
                    appendMessage(chat, chat.senderId == user.userId ? 'You' : `${receiver.firstName} ${receiver.lastName}`);
                });

                $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
            },
            error: function (xhr) {
                console.error("Error Loading Chat History:", xhr.responseJSON);
            }
        });
    }
    //
    // Add this function to handle connection state
    function ensureConnected() {
        if (!connection || 
            connection.state === signalR.HubConnectionState.Disconnected || 
            connection.state === signalR.HubConnectionState.Disconnecting) {
            console.log("Connection lost, reconnecting...");
            return startSignalRConnection();
        }
        return Promise.resolve();
    }
    
    // Update the sendMessage function
    function sendMessage() {
        let message = $("#message").val();
        
        if (!message.trim()) return;
        
        // Ensure connection is active before sending
        ensureConnected().then(() => {
            let formData = getFormData();
            
            // Create a temporary chat object for immediate display
            const tempChatObject = {
                chatId: null,
                message: message,
                senderId: user.userId,
                receiverId: receiverId,
                timestamp: new Date(),
                isRead: false,
                status: 'sending'
            }
            
            // Append the new message instantly to UI
            appendMessage(tempChatObject, 'You');
            
            // Auto-scroll to the latest message
            $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
            
            // Send message via AJAX (store in DB)
            $.ajax({
                url: `${baseUrl}/chat`,
                method: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    console.log("Message Sent:", response);
                    
                    // Update the temporary message with the real ID and status
                    tempChatObject.chatId = response.chatId;
                    tempChatObject.status = response.status;
                    
                    // Update the message status in UI
                    $(`[data-message-id="null"]:last`).attr('data-message-id', response.chatId)
                        .find('i').replaceWith(getStatusIcon(response.status));
                    
                    // Try to deliver the message via SignalR if connected
                    if (connection && connection.state === signalR.HubConnectionState.Connected) {
                        connection.invoke("SendMessageToUser", receiverId, {
                            chatId: response.chatId,
                            message: message,
                            senderId: user.userId,
                            receiverId: receiverId,
                            timestamp: new Date(),
                            isRead: false
                        }).catch(err => {
                            console.error("Error sending message via SignalR:", err);
                            // If SignalR fails, the message is still saved in DB
                        });
                    }
                },
                error: function (xhr) {
                    console.error("Error Sending Message:", xhr.responseJSON);
                    // Update UI to show error
                    $(`[data-message-id="null"]:last`).find('i').replaceWith('<i class="fa-solid fa-exclamation-circle text-danger"></i>');
                }
            });
            
            // Clear input field after sending
            $("#message").val("");
        });
    }
    
    // Update the SignalR connection setup
    function startSignalRConnection() {
        return new Promise((resolve, reject) => {
            // If there's an existing connection, stop it first
            if (connection) {
                connection.stop().then(() => {
                    console.log("Previous connection stopped");
                }).catch(err => {
                    console.warn("Error stopping previous connection:", err);
                });
            }
            
            connection = new signalR.HubConnectionBuilder()
                .withUrl(`http://localhost:5267/chatHub?userId=${user.userId}`, {
                    withCredentials: false,
                    skipNegotiation: false
                })
                .withAutomaticReconnect([0, 1000, 2000, 5000, 10000, 20000])
                .configureLogging(signalR.LogLevel.Information)
                .build();
            
            // Set up connection event handlers
            connection.onreconnecting(error => {
                console.log("Connection reconnecting:", error);
                $("#chatForm").addClass("disabled");
            });
            
            connection.onreconnected(connectionId => {
                console.log("Connection reconnected. ID:", connectionId);
                $("#chatForm").removeClass("disabled");
            });
            
            connection.onclose(error => {
                console.log("Connection closed:", error);
                $("#chatForm").addClass("disabled");
                // Try to reconnect after a delay
                setTimeout(() => startSignalRConnection(), 5000);
            });
            
            connection.start()
                .then(() => {
                    console.log("Connected to SignalR!");
                    // Enable the chat form after connection
                    $("#chatForm").removeClass("disabled");
                    
                    // Check receiver's online status after connection is established
                    connection.invoke("CheckUserStatus", receiverId)
                        .then(isOnline => {
                            $('#onlineStatus').html(isOnline ? 
                                `<i class="fa-solid fa-circle-check me-1"></i>Online` : 
                                `<i class="fa-solid fa-circle-xmark me-1"></i>Offline`);
                        })
                        .catch(err => console.error("Error checking user status:", err));
                    
                    resolve();
                })
                .catch(err => {
                    console.error("SignalR Connection Error:", err);
                    $("#chatForm").addClass("disabled");
                    setTimeout(() => startSignalRConnection(), 5000);
                    reject(err);
                });
            
            // Handle incoming messages
            connection.on("ReceiveMessage", function (chat) {
                console.log("Received message:", chat);
                
                // Check if this message is already displayed (to avoid duplicates)
                if ($(`[data-message-id="${chat.chatId}"]`).length === 0) {
                    appendMessage(chat, chat.senderId === user.userId ? 'You' : receiver.firstName);
                    $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
                }
                
                // Acknowledge message receipt
                if (chat.senderId !== user.userId) {
                    connection.invoke("AcknowledgeMessage", chat.chatId, chat.senderId)
                        .catch(err => console.error("Error acknowledging message:", err));
                }
            });
            
            // Handle online/offline status updates
            connection.on("UserOnline", function(userId) {
                console.log("User online notification received for:", userId);
                if(userId === receiverId) {
                    $('#onlineStatus').html(`<i class="fa-solid fa-circle-check me-1"></i>Online`);
                }
            });
            
            connection.on("UserOffline", function(userId) {
                console.log("User offline notification received for:", userId);
                if(userId === receiverId) {
                    $('#onlineStatus').html(`<i class="fa-solid fa-circle-xmark me-1"></i>Offline`);
                }
            });
            
            connection.on("MessageStatus", function (messageId, status) {
                console.log("Message status update:", messageId, status);
                const messageElement = $(`[data-message-id="${messageId}"]`);
                if (messageElement.length) {
                    messageElement.find('i').replaceWith(getStatusIcon(status));
                }
            });
        });
    }
    
    // Update document ready function to add window events
    $(document).ready(function () {
        let notificationConnection;
        
        loadReceiverData()
        .then(() => {
            loadChatHistory();
            startSignalRConnection();
            return startNotificationConnection();
        })
        .then(conn => {
            notificationConnection = conn;
        });
    
        $("#chatForm").on("submit", function (e) {
            e.preventDefault();
            sendMessage();
        });
        
        // Add window focus/blur events to handle tab switching
        $(window).on('focus', function() {
            console.log('Window focused - checking connection');
            ensureConnected();
        });
        
        // Add beforeunload event to properly disconnect
        $(window).on('beforeunload', function() {
            if (connection) {
                // Try to gracefully disconnect
                connection.stop().catch(() => {});
            }
            if (notificationConnection) {
                notificationConnection.stop().catch(() => {});
            }
        });
    });
</script>
}